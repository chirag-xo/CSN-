// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE MODELS
// ============================================================================

// Chapter model - Essential for CSN community structure
model Chapter {
  id        String   @id @default(uuid())
  name      String   @unique
  city      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users  User[]
  events Event[]

  @@index([city])
}

// User model - Extended for CSN profile system
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String // NEVER expose this in queries
  firstName String
  lastName  String
  company   String?
  position  String?
  city      String?
  phone     String?
  
  // Profile fields
  profilePhoto         String?
  profilePhotoPublicId String? // Cloudinary public_id for deletion
  tagline      String?
  bio          String?
  
  // Verification
  emailVerified     Boolean   @default(false)
  emailVerifiedAt   DateTime?
  phoneVerified     Boolean   @default(false)
  phoneVerifiedAt   DateTime?
  communityVerified Boolean   @default(false)
  
  // Social Links (JSON)
  socialLinks       String?
  
  // Chapter relationship
  chapterId String?
  chapter   Chapter? @relation(fields: [chapterId], references: [id])
  
  // Showcase Fields
  topProjectTitle       String?
  topProjectDescription String?
  topConnectionIds      String[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Referral relationships
  referralsGiven    Referral[]     @relation("ReferralFrom")
  referralsReceived Referral[]     @relation("ReferralTo")
  
  // CSN Profile relationships
  interests            UserInterest[]
  eventsCreated        Event[]            @relation("EventCreator")
  eventsAttending      EventAttendee[]
  testimonialsGiven    Testimonial[]      @relation("TestimonialFrom")
  testimonialsReceived Testimonial[]      @relation("TestimonialTo")
  privacy              UserPrivacy?
  photosUploaded       EventPhoto[]
  galleryPhotos        GalleryPhoto[]     @relation("UserGalleryPhotos")
  verifications        UserVerification[] @relation("UserBeingVerified")
  verificationsGiven   UserVerification[] @relation("Verifier")
  
  // Connection relationships
  sentConnections      Connection[]       @relation("ConnectionRequests")
  receivedConnections  Connection[]       @relation("ConnectionReceived")

  @@index([email])
  @@index([chapterId])
  @@index([emailVerified])
  @@index([communityVerified])
}

// Referral model
model Referral {
  id            String   @id @default(uuid())
  fromUserId    String
  toUserId      String
  type          String   @default("BUSINESS") // BUSINESS, INTRO, SUPPORT
  description   String
  contactName   String?
  contactEmail  String?
  contactPhone  String?
  businessValue Float?
  status        String   @default("PENDING") // PENDING, CONVERTED, CLOSED
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relationships
  fromUser    User          @relation("ReferralFrom", fields: [fromUserId], references: [id])
  toUser      User          @relation("ReferralTo", fields: [toUserId], references: [id])
  testimonial Testimonial?

  @@index([fromUserId])
  @@index([toUserId])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// INTEREST SYSTEM
// ============================================================================

model InterestCategory {
  id        String     @id @default(uuid())
  name      String     @unique
  type      String     // PROFESSIONAL, LIFESTYLE, LEARNING, SOCIAL
  interests Interest[]
}

model Interest {
  id         String   @id @default(uuid())
  name       String   @unique
  categoryId String
  category   InterestCategory @relation(fields: [categoryId], references: [id])
  users      UserInterest[]

  @@index([categoryId])
}

model UserInterest {
  id         String   @id @default(uuid())
  userId     String
  interestId String
  visibility String   @default("PUBLIC") // PUBLIC, CONNECTIONS, PRIVATE
  createdAt  DateTime @default(now())
  
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  interest Interest @relation(fields: [interestId], references: [id])
  
  @@unique([userId, interestId])
  @@index([userId])
  @@index([interestId])
}

// ============================================================================
// EVENT SYSTEM
// ============================================================================

model Event {
  id             String   @id @default(uuid())
  title          String
  description    String
  type           String   // NETWORKING, WORKSHOP, SOCIAL, EDUCATIONAL, COMMUNITY, ONE_TO_ONE
  location       String?
  isVirtual      Boolean  @default(false)
  virtualLink    String?
  date           DateTime
  endDate        DateTime?
  isRecurring    Boolean  @default(false)
  recurrenceType String?  // WEEKLY, MONTHLY
  isPublic       Boolean  @default(true)  // Public vs Private events
  
  chapterId String?
  chapter   Chapter? @relation(fields: [chapterId], references: [id])
  
  creatorId String
  creator   User   @relation("EventCreator", fields: [creatorId], references: [id])
  
  attendees    EventAttendee[]
  photos       EventPhoto[]
  testimonials Testimonial[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([date])
  @@index([creatorId])
  @@index([chapterId])
  @@index([type])
}

model EventAttendee {
  id        String   @id @default(uuid())
  eventId   String
  userId    String
  status    String   @default("GOING") // GOING, MAYBE, DECLINED
  role      String   @default("ATTENDEE") // ATTENDEE, HOST, ORGANIZER
  createdAt DateTime @default(now())
  
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])
  
  @@unique([eventId, userId])
  @@index([userId])
  @@index([eventId])
  @@index([status])
}

model EventPhoto {
  id         String   @id @default(uuid())
  eventId    String
  url        String
  uploadedBy String
  createdAt  DateTime @default(now())
  
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [uploadedBy], references: [id])
  
  @@index([eventId])
  @@index([uploadedBy])
}

// ============================================================================
// TESTIMONIAL SYSTEM
// ============================================================================

model Testimonial {
  id         String   @id @default(uuid())
  fromUserId String
  toUserId   String
  type       String   // PROFESSIONAL, REFERRAL, EVENT, CHARACTER
  content    String
  
  // Context linking (must have one)
  referralId String? @unique
  eventId    String?
  
  visibility String   @default("PUBLIC") // PUBLIC, CONNECTIONS, PRIVATE
  createdAt  DateTime @default(now())
  
  fromUser User      @relation("TestimonialFrom", fields: [fromUserId], references: [id])
  toUser   User      @relation("TestimonialTo", fields: [toUserId], references: [id])
  referral Referral? @relation(fields: [referralId], references: [id])
  event    Event?    @relation(fields: [eventId], references: [id])
  
  @@unique([fromUserId, toUserId, referralId])
  @@index([toUserId])
  @@index([fromUserId])
  @@index([type])
}

// ============================================================================
// PRIVACY SYSTEM
// ============================================================================

model UserPrivacy {
  id                  String @id @default(uuid())
  userId              String @unique
  
  emailVisibility     String @default("PUBLIC")
  phoneVisibility     String @default("PRIVATE")
  eventsVisibility    String @default("CONNECTIONS")
  interestsVisibility String @default("PUBLIC")
  activityVisibility  String @default("CONNECTIONS")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================================================
// VERIFICATION SYSTEM
// ============================================================================

model UserVerification {
  id         String   @id @default(uuid())
  userId     String   // User being verified
  verifiedBy String   // User doing the verification
  createdAt  DateTime @default(now())
  
  user     User @relation("UserBeingVerified", fields: [userId], references: [id], onDelete: Cascade)
  verifier User @relation("Verifier", fields: [verifiedBy], references: [id])
  
  @@unique([userId, verifiedBy])
  @@index([userId])
  @@index([verifiedBy])
}

// ============================================================================
// CONTACT SYSTEM
// ============================================================================

model ContactRequest {
  id        String   @id @default(uuid())
  name      String
  email     String
  reason    String
  status    String   @default("PENDING") // PENDING, RESOLVED
  createdAt DateTime @default(now())

  @@index([status])
  @@index([email])
}

// ============================================================================
// CONNECTION SYSTEM
// ============================================================================

// Connection model - Manages user networking relationships
model Connection {
  id              String           @id @default(uuid())
  
  // The user who initiated the connection request
  requesterId     String
  requester       User             @relation("ConnectionRequests", fields: [requesterId], references: [id], onDelete: Cascade)
  
  // The user who received the connection request
  addresseeId     String
  addressee       User             @relation("ConnectionReceived", fields: [addresseeId], references: [id], onDelete: Cascade)
  
  // Connection status: PENDING, ACCEPTED, DECLINED, BLOCKED
  status          String           @default("PENDING")
  
  // Optional message when sending request
  requestMessage  String?
  
  // Who last acted (for undo/notifications)
  lastActionBy    String?
  
  // Timestamps
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  acceptedAt      DateTime?
  
  // Prevent duplicate connection requests
  @@unique([requesterId, addresseeId])
  @@index([requesterId, status])
  @@index([addresseeId, status])
  @@index([status])
}

// ============================================================================
// GALLERY SYSTEM
// ============================================================================

model GalleryPhoto {
  id                 String   @id @default(uuid())
  userId             String
  url                String   // Cloudinary secure_url
  cloudinaryPublicId String?  // Cloudinary public_id for deletion (nullable for backwards compatibility)
  caption            String?
  isFeatured         Boolean  @default(false)
  featuredAt         DateTime?
  uploadedAt         DateTime @default(now())
  
  user User @relation("UserGalleryPhotos", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([uploadedAt])
  @@index([isFeatured])
}
